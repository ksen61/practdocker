name: Django CI

on:
  push:
    branches: [master]

env:
  DJANGO_SETTINGS_MODULE: myproject.settings
  VENV_PATH: .venv
  SECRET_KEY: ci-secret-key
  DB_NAME: gitlab_ci
  DB_USER: gitlab_ci
  DB_PASSWORD: gitlab_ci
  DB_HOST: postgres
  DB_PORT: "5432"

jobs:
  build_project:
    name: Build project (collectstatic)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Restore cache
        uses: actions/cache@v6
        with:
          path: |
            .venv
            ~/.cache/pip
          key: ${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-req-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-req-

      - name: Create venv and install libs
        run: |
          [ -d "$VENV_PATH" ] || python3 -m venv "$VENV_PATH"
          "$VENV_PATH/bin/pip" install --upgrade pip
          "$VENV_PATH/bin/pip" install -r requirements.txt

      - name: Collect static
        run: |
          mkdir -p artifacts
          "$VENV_PATH/bin/python" manage.py collectstatic --noinput > artifacts/collectstatic.txt

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-artifacts
          path: |
            artifacts/collectstatic.txt
            staticfiles/
          if-no-files-found: warn

  lint_flake8:
    name: Lint (flake8)
    runs-on: ubuntu-latest
    needs: build_project
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Restore cache
        uses: actions/cache@v6
        with:
          path: |
            .venv
            ~/.cache/pip
          key: ${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-req-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-req-

      - name: Create venv and install libs
        run: |
          [ -d "$VENV_PATH" ] || python3 -m venv "$VENV_PATH"
          "$VENV_PATH/bin/pip" install --upgrade pip
          "$VENV_PATH/bin/pip" install -r requirements.txt

      - name: Run flake8
        run: |
          "$VENV_PATH/bin/pip" install flake8
          mkdir -p artifacts
          "$VENV_PATH/bin/flake8" . --select=E9,F63,F7,F82 --exclude venv,.venv,**/migrations/* > artifacts/flake8.txt

      - name: Upload lint artifacts
        uses: actions/upload-artifact@v6
        with:
          name: flake8-artifacts
          path: artifacts/flake8.txt
          if-no-files-found: warn

  migrations_check:
    name: Check migrations
    runs-on: ubuntu-latest
    needs: lint_flake8
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Restore cache
        uses: actions/cache@v6
        with:
          path: |
            .venv
            ~/.cache/pip
          key: ${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-req-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-req-

      - name: Create venv and install libs
        run: |
          [ -d "$VENV_PATH" ] || python3 -m venv "$VENV_PATH"
          "$VENV_PATH/bin/pip" install --upgrade pip
          "$VENV_PATH/bin/pip" install -r requirements.txt

      - name: Check migrations
        run: |
          mkdir -p artifacts
          "$VENV_PATH/bin/python" manage.py makemigrations --check --dry-run > artifacts/migrations-check.txt

      - name: Upload migration artifacts
        uses: actions/upload-artifact@v6
        with:
          name: migrations-artifacts
          path: artifacts/migrations-check.txt
          if-no-files-found: warn

  django_check:
    name: Django system check
    runs-on: ubuntu-latest
    needs: lint_flake8
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Restore cache
        uses: actions/cache@v6
        with:
          path: |
            .venv
            ~/.cache/pip
          key: ${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-req-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-py${{ steps.setup-python.outputs.python-version }}-req-

      - name: Create venv and install libs
        run: |
          [ -d "$VENV_PATH" ] || python3 -m venv "$VENV_PATH"
          "$VENV_PATH/bin/pip" install --upgrade pip
          "$VENV_PATH/bin/pip" install -r requirements.txt

      - name: Run Django check
        run: |
          mkdir -p artifacts
          "$VENV_PATH/bin/python" manage.py check > artifacts/django-check.txt

      - name: Upload Django check artifacts
        uses: actions/upload-artifact@v6
        with:
          name: django-check-artifacts
          path: artifacts/django-check.txt
          if-no-files-found: warn
