{% extends 'main/base.html' %}
{% load static %}

{% block title %}Входящие документы | DocumentFlow{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/documents.css' %}">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet">
<style>
    :root {
        --df-bg: #f2f4f7;
        --df-surface: #ffffff;
        --df-text: #1f2328;
        --df-muted: #6b7280;
        --df-primary: #0d5bd3;
        --df-primary-dark: #0a46a6;
        --df-border: #e3e7ee;
        --df-danger: #d93025;
        --df-warning: #f59e0b;
        --df-success: #1f8f45;
        --df-row-overdue: #fff1f1;
        --df-row-soon: #fff8e7;
    }

    body {
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
        background: var(--df-bg);
        color: var(--df-text);
    }

    .page {
        padding: 24px;
    }

    .page-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding: 20px 24px;
        background: var(--df-surface);
        border-radius: 10px;
        border: 1px solid var(--df-border);
        margin-bottom: 16px;
    }

    .page-title {
        font-size: 24px;
        font-weight: 700;
        margin: 0 0 6px 0;
    }

    .page-subtitle {
        font-size: 13px;
        color: var(--df-muted);
    }

    .tabs {
        display: flex;
        gap: 16px;
        background: var(--df-surface);
        border: 1px solid var(--df-border);
        border-radius: 10px;
        padding: 12px 16px;
        margin-bottom: 16px;
    }

    .tab {
        cursor: pointer;
        font-weight: 600;
        color: var(--df-muted);
        padding: 6px 12px;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .tab.active {
        color: var(--df-primary);
        background: rgba(13, 91, 211, 0.08);
    }

    .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        background: var(--df-surface);
        border: 1px solid var(--df-border);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 16px;
    }

    .filter-group label {
        display: block;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--df-muted);
        margin-bottom: 6px;
        font-weight: 700;
    }

    .filter-group input,
    .filter-group select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid var(--df-border);
        border-radius: 6px;
        background: #fff;
        font-size: 14px;
    }

    .filter-actions {
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .btn {
        border: none;
        border-radius: 6px;
        padding: 8px 14px;
        cursor: pointer;
        font-weight: 600;
        font-size: 13px;
    }

    .btn-primary {
        background: var(--df-primary);
        color: #fff;
    }

    .btn-primary:hover {
        background: var(--df-primary-dark);
    }

    .btn-secondary {
        background: #eef1f6;
        color: var(--df-text);
    }

    .table-wrapper {
        background: var(--df-surface);
        border: 1px solid var(--df-border);
        border-radius: 10px;
        overflow: hidden;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    thead {
        background: #f6f8fb;
        border-bottom: 1px solid var(--df-border);
    }

    th,
    td {
        padding: 12px 14px;
        text-align: left;
    }

    tbody tr {
        border-bottom: 1px solid var(--df-border);
        transition: background 0.2s ease;
    }

    tbody tr.row-overdue {
        background: var(--df-row-overdue);
    }

    tbody tr.row-soon {
        background: var(--df-row-soon);
    }
    tbody tr.row-returned {
        background: #fff0f0;
    }

    .reg-link {
        color: var(--df-primary);
        font-weight: 700;
        cursor: pointer;
    }

    .priority-badge {
        font-weight: 600;
    }

    .priority-urgent {
        color: var(--df-danger);
    }

    .priority-high {
        color: #dd6b20;
    }

    .priority-normal {
        color: var(--df-primary);
    }

    .priority-low {
        color: var(--df-muted);
    }

    .status-chip {
        padding: 3px 8px;
        border-radius: 12px;
        background: #eef2ff;
        color: var(--df-primary);
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
    }
    .status-chip-returned {
        background: #b71c1c;
        color: #fff;
        margin-left: 6px;
    }
    .row-completed {
        background: #f5f7fb;
    }
    .completed-icon {
        color: #16a34a;
        margin-right: 6px;
    }

    .deadline-overdue {
        color: var(--df-danger);
        font-weight: 700;
    }

    .deadline-soon {
        color: var(--df-warning);
        font-weight: 700;
    }

    .row-actions {
        display: flex;
        gap: 8px;
    }

    .btn-link {
        background: transparent;
        color: var(--df-primary);
        padding: 0;
        border: none;
        cursor: pointer;
        font-weight: 600;
    }

    .empty {
        text-align: center;
        padding: 40px 20px;
        color: var(--df-muted);
    }

    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 70px 20px 20px 20px;
    }

    .modal.show {
        display: flex;
    }

    .modal-card {
        background: var(--df-surface);
        border-radius: 12px;
        border: 1px solid var(--df-border);
        max-width: 960px;
        width: 100%;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
        max-height: 85vh;
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .modal-title {
        font-size: 18px;
        font-weight: 700;
    }

    .modal-body {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        overflow-y: auto;
        padding-right: 6px;
    }

    .detail-card {
        border: 1px solid var(--df-border);
        border-radius: 8px;
        padding: 12px;
        background: #fbfcfe;
    }

    .detail-label {
        font-size: 11px;
        text-transform: uppercase;
        color: var(--df-muted);
        margin-bottom: 6px;
        font-weight: 700;
    }

    .detail-value {
        font-size: 14px;
        word-break: break-word;
    }

    .detail-full {
        grid-column: 1 / -1;
    }

    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 16px;
        flex-wrap: wrap;
    }

    .btn-success {
        background: var(--df-success);
        color: #fff;
    }

    .btn-danger {
        background: var(--df-danger);
        color: #fff;
    }

    .comment-box {
        grid-column: 1 / -1;
    }

    .comment-box textarea {
        width: 100%;
        min-height: 80px;
        border: 1px solid var(--df-border);
        border-radius: 6px;
        padding: 8px 10px;
        font-size: 13px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page">
    <div class="page-header">
        <div>
            <h1 class="page-title">{{ page_title|default:"Входящие документы" }}</h1>
            <div class="page-subtitle">{{ page_subtitle|default:"Документы на согласование, ознакомление или исполнение" }}</div>
        </div>
        {% if show_send_button %}
        <div>
            <a class="btn btn-primary" href="/documents/create/">Отправить документ</a>
        </div>
        {% endif %}
    </div>

    <div class="filters">
        <div class="filter-group">
            <label>Поиск</label>
            <input id="searchInput" type="text" placeholder="Номер или тема" oninput="applyFilters()">
        </div>
        <div class="filter-group">
            <label>Статус</label>
            <select id="statusFilter" onchange="applyFilters()">
                <option value="">Все статусы</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Приоритет</label>
            <select id="priorityFilter" onchange="applyFilters()">
                <option value="">Все</option>
                <option value="low">Низкий</option>
                <option value="normal">Обычный</option>
                <option value="high">Высокий</option>
                <option value="urgent">Срочный</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Тип</label>
            <select id="typeFilter" onchange="applyFilters()">
                <option value="">Все типы</option>
            </select>
        </div>
        <div class="filter-actions">
            <button class="btn btn-primary" onclick="applyFilters()">Применить</button>
            <button class="btn btn-secondary" onclick="resetFilters()">Сброс</button>
        </div>
    </div>

    <div id="documentsContainer" class="table-wrapper">
        <div class="empty">Загрузка документов...</div>
    </div>

    <div id="paginationContainer"></div>
</div>

<div id="documentModal" class="modal">
    <div class="modal-card">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle"></div>
            <button class="btn btn-secondary" onclick="closeModal()">Закрыть</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
            <button id="approveBtn" class="btn btn-success" onclick="approveDocument()">Согласовать</button>
            <button id="ackBtn" class="btn btn-primary" onclick="acknowledgeDocument()">Ознакомиться</button>
            <button id="execBtn" class="btn btn-primary" onclick="executeDocument()">Исполнение</button>
            <button id="resubmitBtn" class="btn btn-primary" onclick="resubmitDocument()">Отправить повторно</button>
            <button id="historyBtn" class="btn btn-secondary" onclick="downloadHistory()">Скачать историю</button>
            <button id="archiveBtn" class="btn btn-secondary" onclick="archiveDocument()">В архив</button>
            <button id="rejectBtn" class="btn btn-danger" onclick="rejectDocument()">Отклонить</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.min.js"></script>
<script>
    let currentTab = 'my';
    let currentPage = 1;
    let currentDocument = null;

    function apiFetch(url, options = {}) {
        return fetch(url, { credentials: 'same-origin', ...options });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadStatuses();
        loadDocumentTypes();
        loadDocuments();
    });

    function loadStatuses() {
        apiFetch('/api/document-statuses/')
            .then(r => r.json())
            .then(data => {
                const excluded = ['черновик', 'архив', 'зарегистрирован'];
                const select = document.getElementById('statusFilter');
                data.forEach(status => {
                    const name = (status.name || '').toLowerCase();
                    if (excluded.some(word => name.includes(word))) return;
                    const option = document.createElement('option');
                    option.value = status.id;
                    option.textContent = status.name;
                    select.appendChild(option);
                });
            });
    }

    function loadDocumentTypes() {
        apiFetch('/api/document-types/')
            .then(r => r.json())
            .then(data => {
                const select = document.getElementById('typeFilter');
                data.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.id;
                    option.textContent = type.name;
                    select.appendChild(option);
                });
            });
    }

    function buildUrl() {
        let url = `/api/documents/my/?page=${currentPage}`;

        const search = document.getElementById('searchInput').value;
        const status = document.getElementById('statusFilter').value;
        const priority = document.getElementById('priorityFilter').value;
        const type = document.getElementById('typeFilter').value;

        if (search) url += `&search=${encodeURIComponent(search)}`;
        if (status) url += `&status=${status}`;
        if (priority) url += `&priority=${priority}`;
        if (type) url += `&document_type=${type}`;
        return url;
    }

    function loadDocuments() {
        const container = document.getElementById('documentsContainer');
        container.innerHTML = '<div class="empty">Загрузка документов...</div>';

        apiFetch(buildUrl())
            .then(r => r.json())
            .then(data => {
                renderDocuments(data.results || data);
                if (data.count) {
                    renderPagination(data);
                }
            })
            .catch(() => {
                container.innerHTML = '<div class="empty">Ошибка загрузки документов</div>';
            });
    }

    function renderDocuments(documents) {
        const container = document.getElementById('documentsContainer');
        if (!documents || documents.length === 0) {
            container.innerHTML = '<div class="empty">Документов не найдено</div>';
            return;
        }

        documents = documents.slice().sort((a, b) => {
            const aStatus = (a.status || '').toLowerCase();
            const bStatus = (b.status || '').toLowerCase();
            const aReturned = currentTab === 'my' && aStatus.includes('доработ');
            const bReturned = currentTab === 'my' && bStatus.includes('доработ');
            if (aReturned !== bReturned) return aReturned ? -1 : 1;
            const aCompleted = a.status_is_final || ['согласовано', 'исполнено', 'ознакомлено'].includes(aStatus.trim());
            const bCompleted = b.status_is_final || ['согласовано', 'исполнено', 'ознакомлено'].includes(bStatus.trim());
            if (aCompleted !== bCompleted) return aCompleted ? 1 : -1;
            const aDate = new Date(a.updated_at || a.created_at || 0).getTime();
            const bDate = new Date(b.updated_at || b.created_at || 0).getTime();
            return bDate - aDate;
        });

        let html = `<table>
            <thead>
                <tr>
                    <th>Номер</th>
                    <th>Тема</th>
                    <th>Статус</th>
                    <th>Приоритет</th>
                    <th>Срок</th>
                    <th>Автор</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>`;

        documents.forEach(doc => {
            const deadline = doc.deadline ? new Date(doc.deadline) : null;
            const today = new Date();
            let deadlineClass = '';
            let rowClass = '';
            let deadlineText = doc.deadline ? deadline.toLocaleDateString('ru-RU') : '—';
            const statusText = (doc.status || '').toLowerCase();
            const isReturned = statusText.includes('доработ') || statusText.includes('возвращ');
            const isCompleted = ['согласовано', 'исполнено', 'ознакомлено'].includes(statusText.trim());
            const displayStatus = doc.status;

            // В исходящих не показываем "скоро/просрочено"

            if (isReturned) {
                rowClass = rowClass ? `${rowClass} row-returned` : 'row-returned';
            }
            if (isCompleted) {
                rowClass = rowClass ? `${rowClass} row-completed` : 'row-completed';
            }

            html += `<tr class="${rowClass}">
                <td>
                    ${isCompleted ? '<i class="fas fa-check-circle completed-icon" title="Завершено"></i>' : ''}
                    <span class="reg-link" onclick="openDocument(${doc.id})">${doc.registration_number}</span>
                </td>
                <td>${doc.title}</td>
                <td>
                    <span class="status-chip${isReturned ? ' status-chip-returned' : ''}">${displayStatus}</span>
                </td>
                <td><span class="priority-badge priority-${doc.priority}">${getPriorityText(doc.priority)}</span></td>
                <td><span class="${deadlineClass}">${deadlineText}</span></td>
                <td>${doc.author ? (doc.author.display_name || doc.author.id) : '—'}</td>
                <td>
                    <div class="row-actions">
                        <button class="btn-link" onclick="openDocument(${doc.id})">Открыть</button>
                    </div>
                </td>
            </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderPagination(data) {
        const container = document.getElementById('paginationContainer');
        const totalPages = Math.ceil(data.count / 100);

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = '<div class="tabs">';
        if (data.previous) {
            html += `<div class="tab" onclick="currentPage = ${currentPage - 1}; loadDocuments()">←</div>`;
        }
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage) {
                html += `<div class="tab active">${i}</div>`;
            } else if (i === 1 || i === totalPages || Math.abs(i - currentPage) <= 1) {
                html += `<div class="tab" onclick="currentPage = ${i}; loadDocuments()">${i}</div>`;
            }
        }
        if (data.next) {
            html += `<div class="tab" onclick="currentPage = ${currentPage + 1}; loadDocuments()">→</div>`;
        }
        html += '</div>';
        container.innerHTML = html;
    }

    function getPriorityText(priority) {
        const map = {
            low: 'Низкий',
            normal: 'Обычный',
            high: 'Высокий',
            urgent: 'Срочный'
        };
        return map[priority] || priority;
    }

    function getActionTypeText(actionType) {
        const map = {
            approve: 'Согласование',
            acknowledge: 'Ознакомление',
            execute: 'Исполнение'
        };
        return map[actionType] || '—';
    }

    function openDocument(id) {
        apiFetch(`/api/documents/${id}/`)
            .then(r => r.json())
            .then(doc => {
                currentDocument = doc;
                document.getElementById('modalTitle').textContent = `${doc.registration_number} — ${doc.title}`;

                const rejectionComments = doc.approvals
                    ? doc.approvals
                        .filter(step => step.decision === 'rejected' || step.decision === 'returned')
                        .sort((a, b) => new Date(a.decided_at || 0) - new Date(b.decided_at || 0))
                    : [];
                const firstRejectionComment = rejectionComments.length ? rejectionComments[0].comment : '';

                const versionsByFile = {};
                if (doc.versions && doc.versions.length) {
                    doc.versions.forEach(version => {
                        if (version.file) {
                            versionsByFile[version.file] = version;
                        }
                    });
                }
                const filesHtml = doc.files && doc.files.length
                    ? doc.files.map((file, index) => {
                        const version = versionsByFile[file.file];
                        const versionText = version ? `Версия ${version.version}` : `Версия ${index + 1}`;
                        return `
                            <div>
                                <a href="${file.file}" target="_blank" rel="noopener">
                                    ${file.file_name || file.file}
                                </a>
                                <span style="margin-left: 8px; color: var(--df-muted);">${versionText}</span>
                                ${version && version.version === 1 && firstRejectionComment ? `
                                    <div>Причина отклонения первой версии: ${firstRejectionComment}</div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')
                    : '—';

                let approvalsHtml = '—';
                if (doc.approvals && doc.approvals.length) {
                    const sorted = doc.approvals.slice().sort((a, b) => {
                        const cycleA = a.cycle || 1;
                        const cycleB = b.cycle || 1;
                        if (cycleA !== cycleB) return cycleA - cycleB;
                        const stepA = a.step || 1;
                        const stepB = b.step || 1;
                        if (stepA !== stepB) return stepA - stepB;
                        return new Date(a.created_at || 0) - new Date(b.created_at || 0);
                    });
                    let currentCycle = null;
                    approvalsHtml = sorted.map(step => {
                        const parts = [];
                        if (currentCycle !== (step.cycle || 1)) {
                            currentCycle = step.cycle || 1;
                            parts.push(`<div><strong>Раунд ${currentCycle}</strong></div>`);
                        }
                        parts.push(`
                            <div>
                                <strong>${step.approver?.display_name || '—'}</strong>
                                — ${step.decision_display || step.decision}
                                ${step.comment ? `<div>${step.comment}</div>` : ''}
                            </div>
                        `);
                        return parts.join('');
                    }).join('');
                }

                const rejection = doc.last_rejection_comment
                    ? { comment: doc.last_rejection_comment }
                    : (doc.approvals
                        ? doc.approvals
                            .filter(step => step.decision === 'rejected' || step.decision === 'returned')
                            .sort((a, b) => new Date(b.decided_at || 0) - new Date(a.decided_at || 0))[0]
                        : null);

                const correspondentHtml = doc.correspondent
                    ? `
                        <div class="detail-card">
                            <div class="detail-label">Корреспондент</div>
                            <div class="detail-value">${doc.correspondent}</div>
                        </div>
                    `
                    : '';
                const descriptionHtml = doc.description
                    ? `
                        <div class="detail-card detail-full">
                            <div class="detail-label">Описание</div>
                            <div class="detail-value">${doc.description}</div>
                        </div>
                    `
                    : '';
                const filesBlockHtml = filesHtml !== '—'
                    ? `
                        <div class="detail-card detail-full">
                            <div class="detail-label">Файлы</div>
                            <div class="detail-value">${filesHtml}</div>
                        </div>
                    `
                    : '';
                const statusText = (doc.status || '').toLowerCase();
                const canResubmit = statusText.includes('черновик') || statusText.includes('доработ');
                const commentBlockHtml = canResubmit
                    ? `
                        <div class="detail-card comment-box">
                            <div class="detail-label">Комментарий</div>
                            <textarea id="approvalComment" placeholder="Добавьте комментарий..."></textarea>
                        </div>
                    `
                    : '';
                const newFilesBlockHtml = canResubmit
                    ? `
                        <div class="detail-card detail-full">
                            <div class="detail-label">Новые файлы</div>
                            <input type="file" id="resubmitFiles" multiple>
                        </div>
                    `
                    : '';

                const html = `
                    <div class="detail-card">
                        <div class="detail-label">Тип</div>
                        <div class="detail-value">${doc.document_type_name || doc.document_type || '—'}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Тип обработки</div>
                        <div class="detail-value">${getActionTypeText(doc.action_type)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Статус</div>
                        <div class="detail-value">${doc.status || '—'}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Приоритет</div>
                        <div class="detail-value">${getPriorityText(doc.priority)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Срок</div>
                        <div class="detail-value">${doc.deadline ? new Date(doc.deadline).toLocaleDateString('ru-RU') : '—'}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Автор</div>
                        <div class="detail-value">${doc.author.display_name || doc.author.id}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-label">Входящая дата</div>
                        <div class="detail-value">${doc.external_date ? new Date(doc.external_date).toLocaleDateString('ru-RU') : '—'}</div>
                    </div>
                    ${correspondentHtml}
                    ${descriptionHtml}
                    ${filesBlockHtml}
                    <div class="detail-card detail-full">
                        <div class="detail-label">Согласование</div>
                        <div class="detail-value">${approvalsHtml}</div>
                    </div>
                    ${rejection ? `
                        <div class="detail-card detail-full">
                            <div class="detail-label">Причина отклонения</div>
                            <div class="detail-value">${rejection.comment || '—'}</div>
                        </div>
                    ` : ''}
                    ${commentBlockHtml}
                    ${newFilesBlockHtml}
                `;

                document.getElementById('modalBody').innerHTML = html;
                const buttons = ['approveBtn', 'ackBtn', 'execBtn', 'rejectBtn', 'resubmitBtn', 'historyBtn', 'archiveBtn'];
                buttons.forEach(id => {
                    const btn = document.getElementById(id);
                    btn.style.display = 'none';
                });
                document.getElementById('historyBtn').style.display = 'inline-flex';
                if (canResubmit) {
                    document.getElementById('resubmitBtn').style.display = 'inline-flex';
                }
                const finalStatuses = ['согласовано', 'ознакомлено', 'исполнено'];
                const isFinalStatus = finalStatuses.includes(statusText.trim());
                if (isFinalStatus && !doc.is_archived) {
                    document.getElementById('archiveBtn').style.display = 'inline-flex';
                }
                document.getElementById('documentModal').classList.add('show');
            })
            .catch(() => {
                alert('Не удалось открыть документ');
            });
    }

    function closeModal() {
        document.getElementById('documentModal').classList.remove('show');
        currentDocument = null;
    }

    function approveDocument() {
        sendAction('approve', '/approve/', 'Документ согласован');
    }

    function rejectDocument() {
        sendAction('reject', '/reject/', 'Документ отклонен');
    }

    function acknowledgeDocument() {
        sendAction('acknowledge', '/acknowledge/', 'Документ отмечен как ознакомленный');
    }

    function executeDocument() {
        sendAction('execute', '/execute/', 'Документ отмечен как исполненный');
    }

    function resubmitDocument() {
        if (!currentDocument) return;

        const formData = new FormData();
        formData.append('action_type', currentDocument.action_type || 'approve');

        const approvals = currentDocument.approvals || [];
        const maxStep = approvals.reduce((max, step) => Math.max(max, step.step || 1), 1);
        const approvalOrder = currentDocument.approval_order || (maxStep > 1 ? 'sequential' : 'parallel');
        formData.append('approval_order', approvalOrder);

        if (currentDocument.delivery_mode === 'manual') {
            const storedRoute = currentDocument.manual_route;
            if (Array.isArray(storedRoute) && storedRoute.length > 0) {
                formData.append('manual_route', JSON.stringify(storedRoute));
            } else {
                const route = approvals
                    .sort((a, b) => (a.step || 1) - (b.step || 1))
                    .map(step => step.approver?.id)
                    .filter(Boolean)
                    .filter((id, index, arr) => arr.indexOf(id) === index)
                    .map(id => ({ type: 'user', id }));
                formData.append('manual_route', JSON.stringify(route));
            }
        }

        const filesInput = document.getElementById('resubmitFiles');
        if (filesInput && filesInput.files.length > 0) {
            for (let i = 0; i < filesInput.files.length; i++) {
                formData.append('files', filesInput.files[i]);
            }
        }

        apiFetch(`/api/documents/${currentDocument.id}/resubmit/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(r => r.json())
        .then(() => {
            closeModal();
            loadDocuments();
        })
        .catch(() => {
            closeModal();
            loadDocuments();
        });
    }

    function downloadHistory() {
        if (!currentDocument) return;
        window.location.href = `/api/documents/${currentDocument.id}/history/`;
    }

    function archiveDocument() {
        if (!currentDocument) return;

        apiFetch(`/api/documents/${currentDocument.id}/archive/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(r => r.json())
        .then(() => {
            closeModal();
            loadDocuments();
        })
        .catch(() => {
            closeModal();
            loadDocuments();
        });
    }

    function sendAction(action, endpoint, successMessage) {
        if (!currentDocument) return;
        const comment = document.getElementById('approvalComment')?.value || '';

        apiFetch(`/api/documents/${currentDocument.id}${endpoint}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ comment, action })
        })
        .then(r => r.json())
        .then(() => {
            closeModal();
            loadDocuments();
        })
        .catch(() => {
            closeModal();
            loadDocuments();
        });
    }

    function applyFilters() {
        currentPage = 1;
        loadDocuments();
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('priorityFilter').value = '';
        document.getElementById('typeFilter').value = '';
        applyFilters();
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
